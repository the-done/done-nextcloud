name: Release to App Store

on:
  release:
    types: [published]

env:
  APP_NAME: done

jobs:
  build_and_publish:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    # Uncomment if your repository is in Nextcloud organization
    # environment: release

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: ${{ env.APP_NAME }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer:v2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: ${{ env.APP_NAME }}
        run: |
          composer install --no-dev --optimize-autoloader
          npm ci
          npm run build

      - name: Setup signing certificates
        working-directory: ${{ env.APP_NAME }}
        run: |
          echo "${{ secrets.APP_PRIVATE_KEY }}" > /tmp/done.key
          echo "${{ secrets.APP_PUBLIC_CRT }}" > /tmp/done.crt

      - name: Download Nextcloud server
        run: |
          wget https://download.nextcloud.com/server/releases/latest.tar.bz2
          tar -xjf latest.tar.bz2
          rm latest.tar.bz2

      - name: Build app package
        working-directory: ${{ env.APP_NAME }}
        run: |
          mkdir -p build/artifacts/appstore
          mkdir -p build/artifacts/sign/${{ env.APP_NAME }}

          # Copy app files
          rsync -a \
            --exclude=/.git \
            --exclude=/.github \
            --exclude=/build \
            --exclude=/bin \
            --exclude=/node_modules \
            --exclude=/tests \
            --exclude=/vendor-bin \
            --exclude=/.gitignore \
            --exclude=/.php-cs-fixer.cache \
            --exclude=/Makefile \
            --exclude=/webpack.js \
            --exclude=/package.json \
            --exclude=/package-lock.json \
            --exclude=/psalm.xml \
            --exclude=/stylelint.config.js \
            --exclude=/src \
            . build/artifacts/sign/${{ env.APP_NAME }}/

      - name: Sign app
        working-directory: nextcloud
        run: |
          php occ integrity:sign-app \
            --privateKey=/tmp/done.key \
            --certificate=/tmp/done.crt \
            --path=../${{ env.APP_NAME }}/build/artifacts/sign/${{ env.APP_NAME }}

      - name: Create tarball
        working-directory: ${{ env.APP_NAME }}
        run: |
          cd build/artifacts/sign
          tar -czf ../${{ env.APP_NAME }}.tar.gz ${{ env.APP_NAME }}

      - name: Attach tarball to GitHub release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.RELEASE_TOKEN }}
          file: ${{ env.APP_NAME }}/build/artifacts/${{ env.APP_NAME }}.tar.gz
          asset_name: ${{ env.APP_NAME }}.tar.gz
          tag: ${{ github.ref }}
          overwrite: true

      - name: Upload to Nextcloud App Store
        uses: R0Wi/nextcloud-appstore-push-action@v1
        with:
          app_name: ${{ env.APP_NAME }}
          appstore_token: ${{ secrets.APPSTORE_TOKEN }}
          download_url: ${{ github.server_url }}/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.APP_NAME }}.tar.gz
          app_private_key: ${{ secrets.APP_PRIVATE_KEY }}
          nightly: ${{ github.event.release.prerelease }}
